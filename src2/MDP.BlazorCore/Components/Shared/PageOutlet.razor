@using System.Text.Json;

@namespace MDP.BlazorCore
@implements IDisposable
@code {

    // Constants    
    internal static readonly object PageDataSectionId = new();

    internal static readonly object PageScriptSectionId = new();


    // Fields
    [Inject]
    public IJSRuntime _jsRuntime { get; set; }

    [Inject]
    public IServiceProvider _serviceProvider { get; set; }

    [Inject]
    public NavigationManager _navigationManager { get; set; }

    [Inject]
    public AuthenticationStateProvider _authenticationStateProvider { get; set; }

    [Inject]
    public InteropManager _interopManager { get; set; }

    private DotNetObjectReference<PageOutlet> _interopGateway = null;


    // Constructors        
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        // Require
        if (firstRender == false) return;

        // InteropGateway
        _interopGateway = DotNetObjectReference.Create(this);
        if (_interopGateway == null) throw new InvalidOperationException($"{nameof(_interopGateway)}=null");

        // Initialize
        await _jsRuntime.InvokeVoidAsync("mdp.blazor.interopManager.initialize", _interopGateway);
    }

    public void Dispose()
    {
        // InteropReference
        _interopGateway?.Dispose();
    }


    // Methods
    [JSInvokable]
    public async Task<object> InvokeAsync(string path, JsonDocument payload)
    {
        #region Contracts

        ArgumentNullException.ThrowIfNullOrEmpty(path);
        ArgumentNullException.ThrowIfNull(payload);

        #endregion

        // RootUrl
        var rootUrl = _navigationManager.BaseUri;
        if (string.IsNullOrEmpty(rootUrl) == true) throw new InvalidOperationException($"{nameof(rootUrl)}=null");

        // InvokeAsync
        return _interopManager?.InvokeAsync(new InteropRequest
        (
            new Uri(new Uri(rootUrl), path),
            payload,
            (await _authenticationStateProvider.GetAuthenticationStateAsync())?.User,
            _serviceProvider
        ));
    }
}


<SectionOutlet SectionId="@PageDataSectionId" />
<SectionOutlet SectionId="@PageScriptSectionId" />
<script>

    // blazorPageLoaded
    document.addEventListener("DOMContentLoaded", function () {

        // pageLoaded
        mdp.blazor.eventManager.dispatchPageLoaded();
    }, { once: true });
</script>